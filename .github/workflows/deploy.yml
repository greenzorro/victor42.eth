name: Build Hugo Site

# è§¦å‘æ¡ä»¶
on:
  push:
    branches: [ main, dev ]
  pull_request:
    branches: [ main, dev ]

# æƒé™é…ç½®
permissions:
  contents: write       # è¯»å–å’Œå†™å…¥ä»“åº“å†…å®¹ï¼ˆéœ€è¦æ¨é€åˆ°publishåˆ†æ”¯ï¼‰
  pull-requests: write  # PRè¯„è®º
  statuses: write       # æ›´æ–°commitçŠ¶æ€
  pages: write          # æ¨é€åˆ°publishåˆ†æ”¯

# ç¯å¢ƒå˜é‡
env:
  HUGO_VERSION: '0.111.3'
  HUGO_EXTENDED: true
  NODE_VERSION: '18'

# ä»»åŠ¡å®šä¹‰
jobs:
  # æ„å»ºä»»åŠ¡
  build:
    name: Build Hugo Site
    runs-on: ubuntu-latest

    steps:
      # æ­¥éª¤1: æ£€å‡ºä»£ç 
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: false         # ä¸ä½¿ç”¨Git Submoduleï¼Œæ”¹ç”¨Hugo Modules
          fetch-depth: 0            # è·å–å…¨éƒ¨å†å² (ç”¨äºGitInfo)

      # æ­¥éª¤2: è®¾ç½®Hugo
      - name: Setup Hugo
        uses: peaceiris/actions-hugo@v2
        with:
          hugo-version: ${{ env.HUGO_VERSION }}
          extended: ${{ env.HUGO_EXTENDED }}

      # æ­¥éª¤2.5: å®‰è£…Hugo Modulesä¾èµ– â­ å…³é”®å˜æ›´
      - name: Install Hugo Modules
        run: |
          echo "ğŸ”„ åˆå§‹åŒ–Hugo Modules..."
          # å¯ç”¨Goæ¨¡å—
          export GO111MODULE=on
          # ä½¿ç”¨hugoè‡ªåŠ¨ç®¡ç†æ¨¡å—
          hugo mod tidy
          echo "âœ… æ¨¡å—é…ç½®å®Œæˆ"
          # ä¸‹è½½æ¨¡å—åˆ°æœ¬åœ°ç¼“å­˜
          hugo mod download
          echo "âœ… æ¨¡å—ç¼“å­˜å®Œæˆ"

      # æ­¥éª¤3: è®¾ç½®Node.js (ç”¨äºStackä¸»é¢˜SCSSç¼–è¯‘)
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          # æ³¨æ„: ä¸ä½¿ç”¨cacheï¼Œå› ä¸ºä¸»é¢˜æ²¡æœ‰package-lock.json

      # æ­¥éª¤3.5: éªŒè¯Hugo Modules
      - name: Verify Hugo Modules
        run: |
          echo "ğŸ” éªŒè¯Hugo Modulesé…ç½®..."
          cat go.mod
          echo ""
          echo "ğŸ” æ£€æŸ¥æ¨¡å—ç¼“å­˜..."
          hugo mod graph
          echo ""
          echo "ğŸ” éªŒè¯ä¸»é¢˜å­˜åœ¨..."
          ls -la $(go env GOPATH)/pkg/mod/github.com/caijimmy/ 2>/dev/null || echo "æ¨¡å—ç¼“å­˜ä½ç½®æœªçŸ¥"

      # æ­¥éª¤3.6: å¤åˆ¶Stackä¸»é¢˜assets â­ å…³é”®æ­¥éª¤
      - name: Copy Stack Theme Assets
        run: |
          echo "ğŸ“ å¤åˆ¶Stackä¸»é¢˜èµ„æºæ–‡ä»¶..."
          # ä½¿ç”¨Hugoç¼“å­˜ç›®å½•
          HUGO_CACHE=$(find /tmp -name "hugo-cache" -type d 2>/dev/null | head -1)
          if [ -z "$HUGO_CACHE" ]; then
            HUGO_CACHE="/tmp/hugo_cache"
            mkdir -p $HUGO_CACHE
          fi

          # æŸ¥æ‰¾æ¨¡å—ç¼“å­˜ä¸­çš„ä¸»é¢˜
          MODULE_CACHE="$HUGO_CACHE/modules/filecache/modules/pkg/mod"
          if [ -d "$MODULE_CACHE" ]; then
            THEME_DIR=$(find $MODULE_CACHE -name "*hugo-theme-stack*v3*" -type d 2>/dev/null | head -1)
            if [ -n "$THEME_DIR" ] && [ -d "$THEME_DIR/assets" ]; then
              echo "âœ… æ‰¾åˆ°ä¸»é¢˜: $THEME_DIR"
              mkdir -p assets
              cp -r $THEME_DIR/assets/* assets/
              echo "âœ… èµ„æºå¤åˆ¶å®Œæˆ"
              echo "SCSSæ–‡ä»¶æ•°: $(find assets -name "*.scss" 2>/dev/null | wc -l)"
              echo "TypeScriptæ–‡ä»¶æ•°: $(find assets -name "*.ts" 2>/dev/null | wc -l)"
              echo "SVGå›¾æ ‡æ–‡ä»¶æ•°: $(find assets/icons -name "*.svg" 2>/dev/null | wc -l)"
            else
              echo "âš ï¸ æœªæ‰¾åˆ°ä¸»é¢˜assetsç›®å½•"
              ls -la $MODULE_CACHE/ 2>/dev/null | head -10
            fi
          else
            echo "âš ï¸ æœªæ‰¾åˆ°æ¨¡å—ç¼“å­˜ç›®å½•: $MODULE_CACHE"
          fi

      # æ­¥éª¤4: éªŒè¯æ„å»ºç¯å¢ƒ
      - name: Verify Build Environment
        run: |
          echo "ğŸ” ç¯å¢ƒéªŒè¯..."
          echo "Hugoç‰ˆæœ¬: $(hugo version)"
          echo "Nodeç‰ˆæœ¬: $(node --version)"
          echo "npmç‰ˆæœ¬: $(npm --version)"
          echo "å†…å®¹ç›®å½•: $(ls -la content/ | head -5)"
          echo "assetsç›®å½•: $(ls -la assets/ 2>/dev/null || echo 'æ— assetsç›®å½•')"
          echo "SCSSèµ„æº: $(find assets/ -name "*.scss" 2>/dev/null | wc -l) ä¸ªæ–‡ä»¶"
          echo "TypeScriptèµ„æº: $(find assets/ -name "*.ts" 2>/dev/null | wc -l) ä¸ªæ–‡ä»¶"
          echo "SVGå›¾æ ‡èµ„æº: $(find assets/icons -name "*.svg" 2>/dev/null | wc -l) ä¸ªæ–‡ä»¶"

      # æ­¥éª¤5: æ‰§è¡ŒHugoæ„å»º
      - name: Build Hugo Site
        run: |
          echo "ğŸ”¨ å¼€å§‹æ„å»ºHugoç«™ç‚¹..."
          hugo --gc --minify --verbose
          echo "âœ… æ„å»ºå®Œæˆ"

      # æ­¥éª¤7: éªŒè¯æ„å»ºäº§ç‰©
      - name: Verify Build Output
        run: |
          echo "ğŸ” éªŒè¯æ„å»ºäº§ç‰©..."
          if [ -d "publish" ]; then
            echo "âœ… publishç›®å½•å­˜åœ¨"
            echo "æ–‡ä»¶æ•°é‡: $(find publish -type f | wc -l)"
            echo "ç›®å½•å¤§å°: $(du -sh publish | cut -f1)"
            echo "é¦–é¡µæ£€æŸ¥: $(test -f publish/index.html && echo 'å­˜åœ¨' || echo 'ç¼ºå¤±')"
            echo "Sitemapæ£€æŸ¥: $(test -f publish/sitemap.xml && echo 'å­˜åœ¨' || echo 'ç¼ºå¤±')"
            echo "RSSæ£€æŸ¥: $(test -f publish/index.xml && echo 'å­˜åœ¨' || echo 'ç¼ºå¤±')"
          else
            echo "âŒ publishç›®å½•ä¸å­˜åœ¨!"
            exit 1
          fi

      # æ­¥éª¤8: éƒ¨ç½²åˆ°GitHub Pages (gh-pagesåˆ†æ”¯) â­
      - name: Deploy to gh-pages
        uses: peaceiris/actions-gh-pages@v3
        if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/dev'
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./publish
          publish_branch: gh-pages

      # æ­¥éª¤9: æ·»åŠ PRè¯„è®º (ä»…PRæ—¶)
      - name: Comment PR with Build Status
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number
            });

            const repoUrl = `https://github.com/${context.repo.owner}/${context.repo.repo}`;
            const publishUrl = `https://github.com/${context.repo.owner}/${context.repo.repo}/tree/publish`;
            const buildStatus = '${{ job.status }}';
            const commentBody = `ğŸ“¦ Hugoæ„å»º${buildStatus === 'success' ? 'æˆåŠŸ' : 'å¤±è´¥'}!

            - **æ„å»ºçŠ¶æ€**: ${buildStatus.toUpperCase()}
            - **Commit**: ${context.sha.substring(0, 7)}
            - **æ„å»ºè€…**: ${context.actor}
            - **æ—¶é—´**: ${new Date().toISOString()}
            - **publishåˆ†æ”¯**: [æŸ¥çœ‹ä»£ç ](${publishUrl})

            > 4EVERLANDç­‰éƒ¨ç½²å¹³å°å¯ç›´æ¥éƒ¨ç½²publishåˆ†æ”¯çš„é™æ€æ–‡ä»¶
            `;

            const botComment = comments.find(comment =>
              comment.user.type === 'Bot' && comment.body.includes('Hugoæ„å»º')
            );

            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: commentBody
              });
            } else {
              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: commentBody
              });
            }

      # æ­¥éª¤10: æ›´æ–°CommitçŠ¶æ€ (ä»…pushåˆ°mainæ—¶)
      - name: Update Commit Status
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        uses: actions/github-script@v7
        with:
          script: |
            const buildStatus = '${{ job.status }}';
            const state = buildStatus === 'success' ? 'success' : 'failure';
            const repoUrl = `https://github.com/${context.repo.owner}/${context.repo.repo}`;

            await github.rest.repos.createCommitStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              sha: context.sha,
              state: state,
              description: `Hugoæ„å»º${buildStatus === 'success' ? 'æˆåŠŸï¼Œpublishåˆ†æ”¯å·²æ›´æ–°' : 'å¤±è´¥'}`,
              context: 'Hugo Build',
              target_url: repoUrl
            });
