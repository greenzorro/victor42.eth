name: Build Hugo Site

# è§¦å‘æ¡ä»¶
on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

# æƒé™é…ç½®
permissions:
  contents: read
  pull-requests: write

# ç¯å¢ƒå˜é‡
env:
  HUGO_VERSION: '0.111.3'
  HUGO_EXTENDED: true
  NODE_VERSION: '18'

# ä»»åŠ¡å®šä¹‰
jobs:
  # æ„å»ºä»»åŠ¡
  build:
    name: Build Hugo Site
    runs-on: ubuntu-latest

    steps:
      # æ­¥éª¤1: æ£€å‡ºä»£ç 
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: true          # æ‹‰å–Stackä¸»é¢˜
          fetch-depth: 0            # è·å–å…¨éƒ¨å†å² (ç”¨äºGitInfo)

      # æ­¥éª¤2: è®¾ç½®Hugo
      - name: Setup Hugo
        uses: peaceiris/actions-hugo@v2
        with:
          hugo-version: ${{ env.HUGO_VERSION }}
          extended: ${{ env.HUGO_EXTENDED }}

      # æ­¥éª¤3: è®¾ç½®Node.js (ç”¨äºStackä¸»é¢˜SCSSç¼–è¯‘)
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          # æ³¨æ„: ä¸ä½¿ç”¨cacheï¼Œå› ä¸ºä¸»é¢˜æ²¡æœ‰package-lock.json

      # æ­¥éª¤4: å®‰è£…Stackä¸»é¢˜ä¾èµ– (å¯é€‰)
      - name: Install Stack Theme Dependencies
        run: |
          echo "ğŸ” æ£€æŸ¥Stackä¸»é¢˜ç»“æ„..."
          ls -la themes/stack/ | head -20
          echo ""
          echo "ğŸ” æ£€æŸ¥æ˜¯å¦å­˜åœ¨package.json..."
          if [ -f "themes/stack/package.json" ]; then
            echo "âœ… å‘ç°package.jsonï¼Œå¼€å§‹å®‰è£…ä¾èµ–..."
            cd themes/stack
            npm ci --silent || true
            echo "âœ… ä¸»é¢˜ä¾èµ–å®‰è£…å®Œæˆ (å¦‚æœ‰é”™è¯¯è¯·å¿½ç•¥)"
            cd ../..
          else
            echo "â„¹ï¸  Stackä¸»é¢˜æ— package.jsonï¼Œè·³è¿‡ä¾èµ–å®‰è£…"
          fi
        continue-on-error: true  # å³ä½¿å¤±è´¥ä¹Ÿä¸å½±å“åç»­æ­¥éª¤

      # æ­¥éª¤4.5: å¤åˆ¶Stackä¸»é¢˜èµ„æºåˆ°ä¸»é¡¹ç›® â­ å…³é”®ä¿®å¤
      - name: Copy Stack Theme Assets
        run: |
          echo "ğŸ”„ å¤åˆ¶Stackä¸»é¢˜èµ„æºæ–‡ä»¶..."
          # Stackä¸»é¢˜ä½¿ç”¨Hugo Modulesï¼ŒGit Submoduleæ— æ³•ç›´æ¥è®¿é—®èµ„æº
          # æˆ‘ä»¬éœ€è¦å°†ä¸»é¢˜çš„assetsç›®å½•å¤åˆ¶åˆ°ä¸»é¡¹ç›®
          if [ -d "themes/stack/assets" ]; then
            echo "ğŸ“ å‘ç°Stackä¸»é¢˜assetsç›®å½•ï¼Œå¼€å§‹å¤åˆ¶..."
            # åˆ›å»ºassets/scssç›®å½•ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
            mkdir -p assets/scss
            # å¤åˆ¶æ‰€æœ‰SCSSæ–‡ä»¶
            cp -r themes/stack/assets/scss/* assets/scss/ 2>/dev/null || true
            echo "âœ… SCSSèµ„æºå¤åˆ¶å®Œæˆ"
            # éªŒè¯å¤åˆ¶ç»“æœ
            ls -la assets/scss/ | head -10
          else
            echo "âŒ æœªæ‰¾åˆ°Stackä¸»é¢˜assetsç›®å½•"
            exit 1
          fi

      # æ­¥éª¤5: éªŒè¯æ„å»ºç¯å¢ƒ
      - name: Verify Build Environment
        run: |
          echo "ğŸ” ç¯å¢ƒéªŒè¯..."
          echo "Hugoç‰ˆæœ¬: $(hugo version)"
          echo "Nodeç‰ˆæœ¬: $(node --version)"
          echo "npmç‰ˆæœ¬: $(npm --version)"
          echo "ä¸»é¢˜ç›®å½•: $(ls -la themes/stack/ | head -5)"
          echo "å†…å®¹ç›®å½•: $(ls -la content/ | head -5)"
          echo "å¤åˆ¶åçš„èµ„æº: $(ls -la assets/scss/ 2>/dev/null || echo 'æ— assets/scss')"

      # æ­¥éª¤6: æ‰§è¡ŒHugoæ„å»º
      - name: Build Hugo Site
        run: |
          echo "ğŸ”¨ å¼€å§‹æ„å»ºHugoç«™ç‚¹..."
          hugo --gc --minify --verbose
          echo "âœ… æ„å»ºå®Œæˆ"

      # æ­¥éª¤7: éªŒè¯æ„å»ºäº§ç‰©
      - name: Verify Build Output
        run: |
          echo "ğŸ” éªŒè¯æ„å»ºäº§ç‰©..."
          if [ -d "publish" ]; then
            echo "âœ… publishç›®å½•å­˜åœ¨"
            echo "æ–‡ä»¶æ•°é‡: $(find publish -type f | wc -l)"
            echo "ç›®å½•å¤§å°: $(du -sh publish | cut -f1)"
            echo "é¦–é¡µæ£€æŸ¥: $(test -f publish/index.html && echo 'å­˜åœ¨' || echo 'ç¼ºå¤±')"
            echo "Sitemapæ£€æŸ¥: $(test -f publish/sitemap.xml && echo 'å­˜åœ¨' || echo 'ç¼ºå¤±')"
            echo "RSSæ£€æŸ¥: $(test -f publish/index.xml && echo 'å­˜åœ¨' || echo 'ç¼ºå¤±')"
          else
            echo "âŒ publishç›®å½•ä¸å­˜åœ¨!"
            exit 1
          fi

      # æ­¥éª¤8: ä¸Šä¼ æ„å»ºäº§ç‰© (ä¾›4EVERLANDç­‰å¹³å°æ‹‰å–)
      - name: Upload Build Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: hugo-site-${{ github.sha }}
          path: publish/
          retention-days: 7

      # æ­¥éª¤9: æ·»åŠ PRè¯„è®º (ä»…PRæ—¶)
      - name: Comment PR with Build Status
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number
            });

            const artifactUrl = `https://github.com/${context.repo.owner}/${context.repo.repo}/suites/${context.runId}`;
            const buildStatus = '${{ job.status }}';
            const commentBody = `ğŸ“¦ Hugoæ„å»º${buildStatus === 'success' ? 'æˆåŠŸ' : 'å¤±è´¥'}!

            - **æ„å»ºçŠ¶æ€**: ${buildStatus.toUpperCase()}
            - **Commit**: ${context.sha.substring(0, 7)}
            - **æ„å»ºè€…**: ${context.actor}
            - **æ—¶é—´**: ${new Date().toISOString()}
            - **Artifact**: [ä¸‹è½½æ„å»ºäº§ç‰©](${artifactUrl})

            > 4EVERLANDç­‰éƒ¨ç½²å¹³å°å°†è‡ªåŠ¨ä»GitHubè·å–æœ€æ–°æ„å»ºäº§ç‰©å¹¶éƒ¨ç½²
            `;

            const botComment = comments.find(comment =>
              comment.user.type === 'Bot' && comment.body.includes('Hugoæ„å»º')
            );

            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: commentBody
              });
            } else {
              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: commentBody
              });
            }

      # æ­¥éª¤10: æ›´æ–°CommitçŠ¶æ€ (ä»…pushåˆ°mainæ—¶)
      - name: Update Commit Status
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        uses: actions/github-script@v7
        with:
          script: |
            const buildStatus = '${{ job.status }}';
            const state = buildStatus === 'success' ? 'success' : 'failure';

            await github.rest.repos.createCommitStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              sha: context.sha,
              state: state,
              description: `Hugoæ„å»º${buildStatus === 'success' ? 'æˆåŠŸ' : 'å¤±è´¥'}`,
              context: 'Hugo Build',
              target_url: `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`
            });
