name: Build and Deploy to IPFS via 4EVERLAND

# è§¦å‘æ¡ä»¶
on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

# æƒé™é…ç½®
permissions:
  contents: read
  pull-requests: write

# ç¯å¢ƒå˜é‡
env:
  HUGO_VERSION: '0.111.3'
  HUGO_EXTENDED: true
  NODE_VERSION: '18'

# ä»»åŠ¡å®šä¹‰
jobs:
  # æ„å»ºä»»åŠ¡
  build:
    name: Build Site
    runs-on: ubuntu-latest

    steps:
      # æ­¥éª¤1: æ£€å‡ºä»£ç 
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: true          # æ‹‰å–Stackä¸»é¢˜
          fetch-depth: 0            # è·å–å…¨éƒ¨å†å² (ç”¨äºGitInfo)

      # æ­¥éª¤2: è®¾ç½®Hugo
      - name: Setup Hugo
        uses: peaceiris/actions-hugo@v2
        with:
          hugo-version: ${{ env.HUGO_VERSION }}
          extended: ${{ env.HUGO_EXTENDED }}

      # æ­¥éª¤3: è®¾ç½®Node.js
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'              # ç¼“å­˜npmä¾èµ–
          cache-dependency-path: |
            themes/stack/package-lock.json
            package-lock.json

      # æ­¥éª¤4: å®‰è£…Stackä¸»é¢˜ä¾èµ– â­ å…³é”®æ­¥éª¤
      - name: Install Stack Theme Dependencies
        run: |
          echo "ğŸ” æ£€æŸ¥Stackä¸»é¢˜æ˜¯å¦æœ‰package.json..."
          if [ -f "themes/stack/package.json" ]; then
            echo "âœ… å‘ç°package.jsonï¼Œå¼€å§‹å®‰è£…ä¾èµ–..."
            cd themes/stack
            npm ci --silent
            echo "âœ… ä¸»é¢˜ä¾èµ–å®‰è£…å®Œæˆ"
            cd ../..
          else
            echo "â„¹ï¸  Stackä¸»é¢˜æ— package.jsonï¼Œè·³è¿‡ä¾èµ–å®‰è£…"
          fi

      # æ­¥éª¤5: éªŒè¯æ„å»ºç¯å¢ƒ
      - name: Verify Build Environment
        run: |
          echo "ğŸ” ç¯å¢ƒéªŒè¯..."
          echo "Hugoç‰ˆæœ¬: $(hugo version)"
          echo "Nodeç‰ˆæœ¬: $(node --version)"
          echo "npmç‰ˆæœ¬: $(npm --version)"
          echo "ä¸»é¢˜ç›®å½•: $(ls -la themes/stack/)"
          echo "ä¸»é¢˜assets: $(ls -la themes/stack/assets/ 2>/dev/null || echo 'æ— assetsç›®å½•')"

      # æ­¥éª¤6: æ‰§è¡Œæ„å»º
      - name: Build Hugo Site
        run: |
          echo "ğŸ”¨ å¼€å§‹æ„å»ºHugoç«™ç‚¹..."
          hugo --gc --minify --verbose
          echo "âœ… æ„å»ºå®Œæˆ"

      # æ­¥éª¤7: éªŒè¯æ„å»ºäº§ç‰©
      - name: Verify Build Output
        run: |
          echo "ğŸ” éªŒè¯æ„å»ºäº§ç‰©..."
          if [ -d "publish" ]; then
            echo "âœ… publishç›®å½•å­˜åœ¨"
            echo "æ–‡ä»¶æ•°é‡: $(find publish -type f | wc -l)"
            echo "ç›®å½•å¤§å°: $(du -sh publish | cut -f1)"
            echo "é¦–é¡µæ£€æŸ¥: $(test -f publish/index.html && echo 'å­˜åœ¨' || echo 'ç¼ºå¤±')"
          else
            echo "âŒ publishç›®å½•ä¸å­˜åœ¨!"
            exit 1
          fi

      # æ­¥éª¤8: ä¸Šä¼ æ„å»ºäº§ç‰© (ç”¨äºè°ƒè¯•)
      - name: Upload Build Artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: hugo-site-${{ github.sha }}
          path: publish/
          retention-days: 7

      # æ­¥éª¤9: éƒ¨ç½²åˆ°4EVERLAND â­ æ ¸å¿ƒæ­¥éª¤
      - name: Deploy to 4EVERLAND
        id: deploy
        uses: 4everland/pin-action@v1.1
        with:
          EVER_TOKEN: ${{ secrets.TOKEN_4EVERLAND }}
          BUILD_LOCATION: ./publish
          EVER_PROJECT_NAME: 'victor42.eth'
          EVER_PROJECT_PLAT: 'IPFS'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # æ­¥éª¤10: è¾“å‡ºéƒ¨ç½²ç»“æœ
      - name: Show Deployment Results
        if: always()
        run: |
          echo "ğŸš€ éƒ¨ç½²ç»“æœ:"
          echo "Hash: ${{ steps.deploy.outputs.hash }}"
          echo "URI: ${{ steps.deploy.outputs.uri }}"
          echo "Project Link: ${{ steps.deploy.outputs.projLink }}"

      # æ­¥éª¤11: æ·»åŠ PRè¯„è®º (ä»…PRæ—¶)
      - name: Comment PR with Deployment Link
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number
            });

            const botComment = comments.find(comment =>
              comment.user.type === 'Bot' && comment.body.includes('4EVERLANDéƒ¨ç½²')
            );

            const deploymentLink = '${{ steps.deploy.outputs.projLink }}';
            const commentBody = `ğŸš€ 4EVERLANDéƒ¨ç½²æˆåŠŸ!

            - **é¢„è§ˆé“¾æ¥**: ${deploymentLink}
            - **Commit**: ${context.sha}
            - **æ„å»ºè€…**: ${context.actor}
            - **æ—¶é—´**: ${new Date().toISOString()}
            `;

            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: commentBody
              });
            } else {
              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: commentBody
              });
            }

      # æ­¥éª¤12: æ›´æ–°CommitçŠ¶æ€ (ä»…pushåˆ°mainæ—¶)
      - name: Update Commit Status
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        uses: actions/github-script@v7
        with:
          script: |
            const deploymentLink = '${{ steps.deploy.outputs.projLink }}';
            await github.rest.repos.createCommitStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              sha: context.sha,
              state: 'success',
              target_url: deploymentLink,
              description: '4EVERLANDéƒ¨ç½²æˆåŠŸ',
              context: '4EVERLAND Deployment'
            });

  # éƒ¨ç½²çŠ¶æ€æ£€æŸ¥
  deploy-status:
    name: Check Deployment Status
    runs-on: ubuntu-latest
    needs: build
    if: always()
    steps:
      - name: Verify Deployment
        run: |
          if [ "${{ needs.build.result }}" == "success" ]; then
            echo "âœ… éƒ¨ç½²æˆåŠŸ"
            exit 0
          else
            echo "âŒ éƒ¨ç½²å¤±è´¥"
            exit 1
          fi
