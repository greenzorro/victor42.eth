name: Build Hugo Site (Dev Preview)

# è§¦å‘æ¡ä»¶ - åªå¯¹devåˆ†æ”¯
on:
  push:
    branches: [ dev ]
  pull_request:
    branches: [ dev ]

# æƒé™é…ç½®
permissions:
  contents: write
  pull-requests: write
  statuses: write
  pages: write

# çŽ¯å¢ƒå˜é‡
env:
  HUGO_VERSION: '0.111.3'
  HUGO_EXTENDED: true
  NODE_VERSION: '18'

# ä»»åŠ¡å®šä¹‰
jobs:
  # æž„å»ºä»»åŠ¡
  build:
    name: Build Site (Dev)
    runs-on: ubuntu-latest

    steps:
      # æ­¥éª¤1: æ£€å‡ºä»£ç 
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: false
          fetch-depth: 0

      # æ­¥éª¤2: è®¾ç½®Hugo
      - name: Setup Hugo
        uses: peaceiris/actions-hugo@v2
        with:
          hugo-version: ${{ env.HUGO_VERSION }}
          extended: ${{ env.HUGO_EXTENDED }}

      # æ­¥éª¤3: è®¾ç½®Node.js
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      # æ­¥éª¤4: éªŒè¯Hugo Modules
      - name: Verify Hugo Modules
        run: |
          echo "ðŸ” éªŒè¯Hugo Modulesé…ç½®..."
          if [ -f "go.mod" ]; then
            echo "âœ… æ‰¾åˆ°go.modæ–‡ä»¶"
            cat go.mod
          else
            echo "âš ï¸  æœªæ‰¾åˆ°go.modæ–‡ä»¶ï¼Œå¯èƒ½éœ€è¦ä»Ždevåˆ†æ”¯èŽ·å–"
          fi

      # æ­¥éª¤5: å°è¯•å®‰è£…Hugo Modules
      - name: Install Hugo Modules
        run: |
          export GO111MODULE=on
          hugo mod tidy || echo "âš ï¸  Hugo Moduleså®‰è£…å¤±è´¥ï¼Œå¯èƒ½éœ€è¦ä»Ždevåˆ†æ”¯èŽ·å–"
          hugo mod download || echo "âš ï¸  Hugo Modulesä¸‹è½½å¤±è´¥"

      # æ­¥éª¤6: å¤åˆ¶Stackä¸»é¢˜èµ„æº
      - name: Copy Stack Theme Assets
        run: |
          if [ -d "themes/stack/assets" ]; then
            echo "ðŸ“ ä»Žthemes/stack/assetså¤åˆ¶èµ„æº..."
            mkdir -p assets
            cp -r themes/stack/assets/* assets/ 2>/dev/null || echo "âš ï¸  ä¸»é¢˜èµ„æºå¤åˆ¶å¤±è´¥"
          elif [ -d "assets" ]; then
            echo "âœ… assetsç›®å½•å·²å­˜åœ¨"
          else
            echo "âš ï¸  æœªæ‰¾åˆ°ä¸»é¢˜èµ„æºï¼Œå°†å°è¯•ä»ŽGoæ¨¡å—ç¼“å­˜èŽ·å–"
          fi

      # æ­¥éª¤7: æ‰§è¡Œæž„å»º
      - name: Build Hugo Site
        run: |
          echo "ðŸ”¨ å¼€å§‹æž„å»ºHugoç«™ç‚¹..."
          hugo --gc --minify --verbose || {
            echo "âš ï¸  é¦–æ¬¡æž„å»ºå¤±è´¥ï¼Œå°è¯•æ¸…ç†åŽé‡æ–°æž„å»º..."
            rm -rf .hugo_build_lock
            hugo --gc --minify
          }

      # æ­¥éª¤8: éªŒè¯æž„å»ºäº§ç‰©
      - name: Verify Build Output
        run: |
          echo "ðŸ” éªŒè¯æž„å»ºäº§ç‰©..."
          if [ -d "publish" ]; then
            echo "âœ… publishç›®å½•å­˜åœ¨"
            echo "æ–‡ä»¶æ•°é‡: $(find publish -type f | wc -l)"
            echo "ç›®å½•å¤§å°: $(du -sh publish | cut -f1)"
            ls -la publish/ | head -20
          else
            echo "âŒ publishç›®å½•ä¸å­˜åœ¨!"
            echo "å½“å‰ç›®å½•å†…å®¹:"
            ls -la
            exit 1
          fi

      # æ­¥éª¤9: éƒ¨ç½²åˆ°dev-pagesåˆ†æ”¯
      - name: Deploy to dev-pages
        uses: peaceiris/actions-gh-pages@v3
        if: github.ref == 'refs/heads/dev'
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./publish
          publish_branch: dev-pages
          keep_files: false
          force_orphan: false

      # æ­¥éª¤10: æ·»åŠ PRè¯„è®º
      - name: Comment PR with Build Status
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const repoUrl = `https://github.com/${context.repo.owner}/${context.repo.repo}`;
            const devPagesUrl = `https://${context.repo.owner}.github.io/${context.repo.repo}/dev/`;
            const commentBody = `ðŸ“¦ Hugoæž„å»ºå®Œæˆ (Devåˆ†æ”¯)

            - **åˆ†æ”¯**: ${context.ref}
            - **Commit**: ${context.sha.substring(0, 7)}
            - **æž„å»ºè€…**: ${context.actor}
            - **æ—¶é—´**: ${new Date().toISOString()}

            ðŸ”— **é¢„è§ˆåœ°å€**:
            - Devé¢„è§ˆ: ${devPagesUrl}

            > è¿™æ˜¯devåˆ†æ”¯çš„é¢„è§ˆæž„å»ºï¼Œä»…ä¾›æµ‹è¯•å’Œé¢„è§ˆ
            `;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: commentBody
            });
